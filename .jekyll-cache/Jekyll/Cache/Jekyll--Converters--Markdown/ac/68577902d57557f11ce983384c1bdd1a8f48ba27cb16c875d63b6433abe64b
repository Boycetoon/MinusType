I"ßu<p>å›æ¥å¡«å‘äº†~~</p>

<p>æœ¬æ–‡ç®—æ˜¯ä¹‹å‰è¡—æ™¯å›¾åƒè·å–çš„åç»­ï¼ŒåŸå¸‚ç ”ç©¶ä¸­ä½¿ç”¨è¡—æ™¯å›¾åƒæ¥è¿›è¡Œç‰©ä½“è¯†åˆ«ä¸è¯­ä¹‰åˆ†å‰²å¯ä»¥è¯´æ˜¯æœ€å¸¸è§çš„åº”ç”¨ï¼Œå½“ç„¶ç°åœ¨è¿™ä¸ªæ–¹é¢å¯ä»¥è¯´æ˜¯å¾ˆæˆç†Ÿäº†ï¼Œä½œä¸ºéäººå·¥æ™ºèƒ½ç®—æ³•ç ”ç©¶é¢†åŸŸçš„ä½¿ç”¨è€…å®Œå…¨æ²¡æœ‰å¿…è¦é€ è½®å­ã€‚ä¹‹å‰æˆ‘è‡ªå·±å¤„ç†æ•°æ®ä¹Ÿæ˜¯ä½¿ç”¨çš„å§šå°§åšå£«åˆ†äº«çš„å°è£…å¥½çš„FCNæ¨¡å‹ï¼ˆåœ¨æ²¡æœ‰ç‰¹æ®Šçš„ç§‘ç ”éœ€è¦çš„æƒ…å†µä¸‹å®Œå…¨å¤Ÿç”¨ï¼‰ã€‚</p>

<p>ä¸è¿‡æœ€è¿‘çœ‹æå°æ±Ÿåšå£«çš„åˆ†äº«è¯´æ˜¯é‡‡ç”¨çš„PSPNetè¿›è¡Œçš„è¯­ä¹‰åˆ†å‰²ï¼Œäºæ˜¯å€Ÿæ­¤æœºä¼šåšäº†äº›å°è¯•ï¼Œå¹¶ä¸”é…åˆä¹‹å‰çš„è¡—æ™¯å›¾åƒè·å–çš„æµç¨‹è¿›è¡Œäº†å®Œå–„ã€‚å¯¹äºè¿™ä¸ªæ–¹æ³•è€Œè¨€ï¼Œé¢„è®­ç»ƒçš„æ¨¡å‹å®Œå…¨æ˜¯ç°æˆçš„ï¼Œç›¸å¯¹çš„ä¼˜åŠ¿å¯èƒ½åœ¨äº<strong>æ”¯æŒGPUè®­ç»ƒæé«˜é€Ÿåº¦</strong>ä»¥åŠ<strong>å’Œè¡—æ™¯è·å–éƒ¨åˆ†ç»“åˆå½¢æˆå®Œæ•´çš„å·¥ä½œæµ</strong>ã€‚</p>

<h2 id="åœ¨cityscapesæ•°æ®é›†ä¸Šé¢„è®­ç»ƒçš„pspnetæ¨¡å‹">åœ¨Cityscapesæ•°æ®é›†ä¸Šé¢„è®­ç»ƒçš„PSPNetæ¨¡å‹</h2>

<p><strong>Pyramid Scene Parsing Networkï¼ˆPSPNetï¼‰</strong> æ˜¯CVPR2017ä¸Šå…³äºåœºæ™¯è§£æçš„æ–‡ç« ï¼Œæ‹¿åˆ°äº†2016å¹´ImageNetæ¯”èµ›ä¸­scene parsingä»»åŠ¡çš„å† å†›ï¼Œå½“ç„¶ä¹Ÿå¸¸ç”¨æ¥åšè¯­ä¹‰åˆ†å‰²ã€‚PSPNetç®—æ³•æ˜¯ç›®å‰åº”ç”¨æ¯”è¾ƒå¹¿æ³›çš„è¯­ä¹‰åˆ†å‰²ç®—æ³•ä¹‹ä¸€ï¼Œè¯¥ç®—æ³•åœ¨PASCAL VOC2012æµ‹è¯•é›†ä¸Šçš„mIOUæ˜¯82.6%ã€‚å½“ç„¶æˆ‘å¯¹ç®—æ³•çš„äº†è§£ä¹Ÿä»…é™äºè¯»è¿‡è®ºæ–‡åŸæ–‡ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹åŸæ–‡é“¾æ¥ï¼š<a href="https://arxiv.org/abs/1612.01105">https://arxiv.org/abs/1612.01105</a>ã€‚
<img src="https://github.com/Boycetoon/MinusType/blob/master/image/stuttgart02-2040x500.png" alt="" />
è¿™é‡Œä½¿ç”¨çš„æ˜¯GluonCVä¸­çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œåœ¨Cityscapesæ•°æ®é›†ä¸Šè¿›è¡Œäº†è®­ç»ƒï¼ŒCityscapesæ˜¯é‡è¦çš„åŸå¸‚è¡—é“å›¾åƒåˆ†å‰²æ•°æ®é›†ï¼Œæ›´åŠ é€‚åˆç”¨æ¥è¿›è¡Œè¡—æ™¯å›¾åƒçš„è¯­ä¹‰åˆ†å‰²ã€‚</p>
<h2 id="é¢„å…ˆå‡†å¤‡">é¢„å…ˆå‡†å¤‡</h2>
<ul>
  <li>ç”±äºä½¿ç”¨çš„æ˜¯GluonCVï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆå®‰è£…GluonCVåŠå…¶ä¾èµ–çš„MXNetï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘ç»™å‡ºçš„å®‰è£…æ–¹å¼è¿›è¡Œå®‰è£…ï¼š<a href="https://cv.gluon.ai/install.html">https://cv.gluon.ai/install.html</a></li>
  <li>MXNetå…·æœ‰CPUç‰ˆæœ¬å’ŒGPUç‰ˆæœ¬ï¼Œåœ¨æ·±åº¦å­¦ä¹ è®¡ç®—ä¸­ä½¿ç”¨GPUè®¡ç®—å¯ä»¥æå¤§åœ°æé«˜é€Ÿåº¦ï¼Œä½†å®‰è£…GPUç‰ˆæœ¬å‰éœ€è¦å®‰è£…CUDAä»¥åŠcuDNNï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/91554516">https://zhuanlan.zhihu.com/p/91554516</a></li>
  <li>ä¸Šè¿°å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦Microsoft Visual C++ 2015ä»¥ä¸Šç‰ˆæœ¬ï¼Œå…·ä½“å®‰è£…åœ°å€å¯ä»¥åœ¨ä¸Šä¸€æ¡çš„æ•™ç¨‹ä¸­æ‰¾åˆ°ã€‚</li>
  <li>ä»£ç éƒ¨åˆ†æ˜¯æŒ‰ç…§GPUè®­ç»ƒç¼–å†™çš„ï¼Œå¦‚æœå®‰è£…çš„CPUç‰ˆæœ¬åˆ™éœ€è¦è¿›è¡Œä¸€å®šçš„ä¿®æ”¹ã€‚
    <h2 id="è¡—æ™¯å›¾åƒæ‰¹é‡è¯­ä¹‰åˆ†å‰²">è¡—æ™¯å›¾åƒæ‰¹é‡è¯­ä¹‰åˆ†å‰²</h2>
  </li>
</ul>

<p>é¦–å…ˆå¯¹å›¾åƒè¿›è¡Œæ‰¹é‡çš„è¯­ä¹‰åˆ†å‰²ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ°æœ¬åœ°csvè¡¨æ ¼ä¸­ã€‚è¿™é‡Œä½¿ç”¨çš„æ–‡ä»¶ç»“æ„ä¸å‘½åæ³•å°†ä¸ä¹‹å‰è¡—æ™¯è·å–çš„æ•™ç¨‹ä¸€è‡´ï¼Œå›¾åƒçš„å‘½åæ–¹å¼ä¸º ID_Lng_Lat_Heading.jpgï¼Œæ¯”å¦‚â€œ61.0_126.6849976_45.7885017_180.jpgâ€ã€‚
<img src="image/2%204.png" alt="" /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å¯¼å…¥éœ€è¦ä½¿ç”¨çš„åŒ…
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mxnet</span> <span class="k">as</span> <span class="n">mx</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">image</span><span class="p">,</span> <span class="n">gpu</span>
<span class="kn">import</span> <span class="nn">gluoncv</span>
<span class="kn">from</span> <span class="nn">gluoncv.data.transforms.presets.segmentation</span> <span class="kn">import</span> <span class="n">test_transform</span>
<span class="kn">from</span> <span class="nn">gluoncv.utils.viz</span> <span class="kn">import</span> <span class="n">get_color_pallete</span><span class="p">,</span><span class="n">plot_image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="n">mpimg</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="c1"># å¿½ç•¥è­¦å‘Š
</span><span class="kn">import</span> <span class="nn">warnings</span><span class="p">;</span> <span class="n">warnings</span><span class="p">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">'once'</span><span class="p">)</span> 
<span class="n">warnings</span><span class="p">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">"ignore"</span><span class="p">)</span>

<span class="c1"># è®¾å®šä½¿ç”¨GPUæˆ–è€…CUPè¿›è¡Œè®¡ç®—ï¼Œæ²¡æœ‰å®‰è£…GPUç‰ˆæœ¬çš„MXNetè¯·ä½¿ç”¨CPU
</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">mx</span><span class="p">.</span><span class="n">gpu</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># å®šä¹‰å‡½æ•°å¯¹å•å¼ å›¾ç‰‡è¿›è¡Œå›¾åƒåˆ†å‰²ï¼Œå¹¶å°†ç»“æœå­˜ä¸ºpd.Series
</span><span class="k">def</span> <span class="nf">get_seg</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
  <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
  <span class="n">img</span> <span class="o">=</span> <span class="n">test_transform</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
  <span class="n">predict</span> <span class="o">=</span> <span class="n">mx</span><span class="p">.</span><span class="n">nd</span><span class="p">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mx</span><span class="p">.</span><span class="n">nd</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">asnumpy</span><span class="p">()</span>
  <span class="c1"># å®šä¹‰Cityscapesæ•°æ®é›†åˆ†å‰²æ ‡ç­¾å­—å…¸
</span>  <span class="n">col_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s">'road'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="s">'sidewalk'</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="s">'building'</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s">'wall'</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="s">'fence'</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="s">'pole'</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="s">'traffic light'</span><span class="p">,</span>
             <span class="mi">7</span><span class="p">:</span><span class="s">'traffic sign'</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span><span class="s">'vegetation'</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span><span class="s">'terrain'</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="s">'sky'</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span><span class="s">'person'</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="s">'rider'</span><span class="p">,</span>
             <span class="mi">13</span><span class="p">:</span><span class="s">'car'</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span><span class="s">'truck'</span><span class="p">,</span> <span class="mi">15</span><span class="p">:</span><span class="s">'bus'</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span><span class="s">'train'</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span><span class="s">'motorcycle'</span><span class="p">,</span> <span class="mi">18</span><span class="p">:</span><span class="s">'bicycle'</span><span class="p">}</span>
  <span class="n">pred</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">):</span>
      <span class="n">pred</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">predict</span><span class="o">==</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">predict</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predict</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
  <span class="n">pred</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pred</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="n">col_map</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">pred</span>

<span class="c1"># ä¸‹è½½æ¨¡å‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯åœ¨Cityscapesæ•°æ®é›†ä¸Šé¢„è®­ç»ƒçš„PSPnetæ¨¡å‹
</span><span class="n">model</span> <span class="o">=</span> <span class="n">gluoncv</span><span class="p">.</span><span class="n">model_zoo</span><span class="p">.</span><span class="n">get_model</span><span class="p">(</span><span class="s">'psp_resnet101_citys'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">file_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'.'</span> <span class="c1"># ä¼ å…¥ä¿å­˜å›¾ç‰‡çš„æ–‡ä»¶å¤¹è·¯å¾„
</span><span class="n">filelist</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'id'</span><span class="p">,</span><span class="s">'lng'</span><span class="p">,</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'heading'</span><span class="p">,</span><span class="s">'road'</span><span class="p">,</span><span class="s">'sidewalk'</span><span class="p">,</span><span class="s">'building'</span><span class="p">,</span><span class="s">'wall'</span><span class="p">,</span><span class="s">'fence'</span><span class="p">,</span>
                         <span class="s">'pole'</span><span class="p">,</span><span class="s">'traffic light'</span><span class="p">,</span><span class="s">'traffic sign'</span><span class="p">,</span><span class="s">'vegetation'</span><span class="p">,</span><span class="s">'terrain'</span><span class="p">,</span><span class="s">'sky'</span><span class="p">,</span>
                         <span class="s">'person'</span><span class="p">,</span><span class="s">'rider'</span><span class="p">,</span><span class="s">'car'</span><span class="p">,</span><span class="s">'truck'</span><span class="p">,</span><span class="s">'bus'</span><span class="p">,</span><span class="s">'train'</span><span class="p">,</span><span class="s">'motorcycle'</span><span class="p">,</span><span class="s">'bicycle'</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span> <span class="c1"># å¾ªç¯éå†æ‰€æœ‰çš„å›¾ç‰‡è¿›è¡Œè¯­ä¹‰åˆ†å‰²ï¼Œå¹¶å°†ç»“æœå­˜å¦‚pd.DataFrame
</span>  <span class="n">img_path</span> <span class="o">=</span> <span class="n">file_path</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">i</span>
  <span class="k">try</span><span class="p">:</span>
      <span class="n">img_id</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">except</span><span class="p">:</span>
      <span class="k">continue</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="n">lng</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
      <span class="n">heading</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
      <span class="n">data_i</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">({</span><span class="s">'id'</span><span class="p">:</span><span class="n">img_id</span><span class="p">,</span> <span class="s">'lng'</span><span class="p">:</span><span class="n">lng</span><span class="p">,</span> <span class="s">'lat'</span><span class="p">:</span><span class="n">lat</span><span class="p">,</span> <span class="s">'heading'</span><span class="p">:</span><span class="n">heading</span><span class="p">}).</span><span class="n">append</span><span class="p">(</span><span class="n">get_seg</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span>
      <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_i</span><span class="p">).</span><span class="n">T</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s">'outer'</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="s">'---------å›¾ç‰‡'</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">'å·²å®Œæˆåˆ†å‰²è®¡ç®—--------'</span><span class="p">)</span>

<span class="n">df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s">"/img_seg.csv"</span><span class="p">)</span> <span class="c1"># å°†ç»“æœä¿å­˜åˆ°csv
</span></code></pre></div></div>
<h2 id="åç»­å¤„ç†ä¸å¯è§†åŒ–">åç»­å¤„ç†ä¸å¯è§†åŒ–</h2>

<p>æœ¬æ¥åšåˆ°è¿™ä¸€æ­¥å°±å¯ä»¥å¯¼å…¥GISè¿›è¡Œä¸‹ä¸€æ­¥è®¡ç®—ï¼Œä½†æ˜¯è¿˜å¹¶ä¸ç®—å®Œå–„ï¼Œå¾—åˆ°çš„æ•°æ®ä¸­å¹¶æ²¡æœ‰å¯¹æ¯ä¸ªç‚¹çš„å››ä¸ªæ–¹å‘çš„å€¼è¿›è¡Œæ±‡æ€»å¹³å‡ï¼Œå¹¶ä¸”å€ŸåŠ©geopandasåŒ…å¯ä»¥å°†æ•°æ®è½¬æ¢ä¸ºshpæ ¼å¼ï¼Œä»¥åŠè¿›è¡Œå¯è§†åŒ–ã€‚æ‰€ä»¥åé¢çš„éƒ¨åˆ†ç®—æ˜¯å¯é€‰å†…å®¹ã€‚</p>
<h3 id="åˆ†å‰²ç»“æœå¯è§†åŒ–">åˆ†å‰²ç»“æœå¯è§†åŒ–</h3>

<p>é¦–å…ˆæ˜¯å¯¹å›¾åƒåˆ†å‰²çš„ç»“æœè¿›è¡Œå¯è§†åŒ–ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å¯¹å•å¼ å›¾ç‰‡è¿›è¡Œå¯è§†åŒ–
</span><span class="n">img_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'.\176.0_126.6819992_45.7871017_180.jpg'</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">test_transform</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">predict</span> <span class="o">=</span> <span class="n">mx</span><span class="p">.</span><span class="n">nd</span><span class="p">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mx</span><span class="p">.</span><span class="n">nd</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="n">asnumpy</span><span class="p">()</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">get_color_pallete</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="s">'citys'</span><span class="p">)</span>
<span class="n">base</span> <span class="o">=</span> <span class="n">mpimg</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="c1">#plt.savefig(".",dpi=150,bbox_inches='tight')
</span></code></pre></div></div>

<p>å¾—åˆ°é’ˆå¯¹å•å¼ åˆ†å‰²ç»“æœçš„é¢œè‰²é®ç½©ï¼š
<img src="image/1%203.png" alt="" /></p>
<h3 id="æ•°æ®æ±‡æ€»å¹¶è½¬ä¸ºshp">æ•°æ®æ±‡æ€»å¹¶è½¬ä¸ºshp</h3>

<p>ç¬¬äºŒæ­¥æ˜¯å°†å•ä¸ªç‚¹çš„å››ä¸ªæ–¹å‘çš„æ•°æ®è¿›è¡Œæ±‡æ€»å¹³å‡ï¼Œå¹¶ä¸”å­˜å‚¨ä¸ºshpæ ¼å¼æ–‡ä»¶ã€‚ä¸è¿‡æˆ‘çš„geopandaså’Œmxnetä¸åœ¨ä¸€ä¸ªç¯å¢ƒï¼Œæ‰€ä»¥è¿™é‡Œåˆ‡æ¢äº†kernelå¹¶ä¸”é‡æ–°å¯¼å…¥äº†ä¸€æ¬¡åŒ…ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å¯¹å¾—åˆ°çš„æ•°æ®è¿›è¡Œå¤„ç†å¹¶ä¿å­˜ä¸ºshp
# ç”±äºgeopandaså’Œmxnetä¸åœ¨åŒä¸€ä¸ªç¯å¢ƒï¼Œæ‰€ä»¥è¿™é‡Œåˆ‡æ¢kernelé‡æ–°å¯¼å…¥ä¸€æ¬¡åŒ…
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>

<span class="n">csv_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'.\img_seg.csv'</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'id'</span><span class="p">).</span><span class="n">mean</span><span class="p">().</span><span class="n">reset_index</span><span class="p">().</span><span class="n">drop</span><span class="p">([</span><span class="s">'Unnamed: 0'</span><span class="p">,</span><span class="s">'heading'</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#
</span><span class="n">data</span><span class="p">[</span><span class="s">'geometry'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">'lng'</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s">'lat'</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">geo_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">geo_data</span><span class="p">.</span><span class="n">to_file</span><span class="p">(</span><span class="s">'./img_seg.shp'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span>
</code></pre></div></div>

<p>æœ€åå°†å¾—åˆ°å¦‚ä¸‹ç»“æ„çš„shpæ–‡ä»¶ï¼š
<img src="image/3%204.png" alt="" /></p>
<h3 id="å¯¹ç»¿è§†ç‡è¿›è¡Œå¯è§†åŒ–">å¯¹ç»¿è§†ç‡è¿›è¡Œå¯è§†åŒ–</h3>

<p>æœ€åä¸€æ­¥æœ¬æ¥ä¹‹å‰æ˜¯åœ¨GISé‡Œå¯è§†åŒ–çš„ï¼Œä¸è¿‡æ—¢ç„¶éƒ½è½¬æˆGeoDataFrameæ ¼å¼äº†ä¹Ÿå¯ä»¥åœ¨Pythoné‡Œè¿›è¡Œã€‚è¿™é‡Œä½¿ç”¨äº†ç‚¹çš„é¢œè‰²è¡¨è¾¾ç»¿è§†ç‡ï¼Œè€Œä½¿ç”¨ç‚¹çš„å¤§å°è¡¨è¾¾å»ºç­‘æ¯”ç‡ã€‚ç”±äºè¿™æ¬¡è¿è¡Œçš„æ•°æ®åªæ˜¯ä¹‹å‰è¡—æ™¯çš„ä¸€å°éƒ¨åˆ†ï¼Œæ•´ä½“å›¾åƒåªæœ‰ä¸€å°å—ï¼Œä½†æ˜¯åœ¨æ›´å¤§é‡æ•°æ®ä¸‹ä¸€æ ·é€‚ç”¨ã€‚è¿™é‡Œå¯¼å…¥äº†å°æ—­å­¦é•¿æä¾›çš„plot_mapåŒ…æ¥ä¸‹è½½OSMåº•å›¾ï¼Œå¯ä»¥å‚è€ƒï¼šhttps://gitee.com/ni1o1/pygeo-tutorialã€‚åŒæ—¶ä¹Ÿæ¨èå°æ—­å­¦é•¿çš„è¿™ä¸€å¥—æ•™ç¨‹ï¼Œéå¸¸å®ç”¨~</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å¯¹ç‚¹æ•°æ®è¿›è¡Œå¯è§†åŒ–ï¼Œè¿™é‡Œä½¿ç”¨äº†é¢œè‰²ä»£è¡¨ç»¿è§†ç‡ï¼Œç‚¹çš„å¤§å°ä»£è¡¨å»ºç­‘æ¯”ç‡
</span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">import</span> <span class="nn">plot_map</span> <span class="c1"># å¯¼å…¥åŒæµå°æ—­å­¦é•¿æä¾›çš„åº•å›¾ç»˜åˆ¶åŒ…
</span>
<span class="n">fig</span>     <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>    
<span class="n">ax</span>      <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">126.65</span><span class="p">,</span><span class="mf">45.78</span><span class="p">,</span><span class="mf">126.69</span><span class="p">,</span><span class="mf">45.79</span><span class="p">]</span>
<span class="n">plot_map</span><span class="p">.</span><span class="n">plot_map</span><span class="p">(</span><span class="n">plt</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">zoom</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">geo_data</span><span class="p">[</span><span class="s">'vegetation'</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="p">.</span><span class="n">colors</span><span class="p">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">cmapname</span> <span class="o">=</span> <span class="s">'autumn_r'</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmapname</span><span class="p">)</span>

<span class="n">color</span><span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">geo_data</span><span class="p">[</span><span class="s">'vegetation'</span><span class="p">]))</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">200</span><span class="o">*</span><span class="p">(</span><span class="n">geo_data</span><span class="p">[</span><span class="s">'building'</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">geo_data</span><span class="p">[</span><span class="s">'building'</span><span class="p">]))</span><span class="o">/</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">geo_data</span><span class="p">[</span><span class="s">'building'</span><span class="p">])</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">geo_data</span><span class="p">[</span><span class="s">'building'</span><span class="p">]))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">geo_data</span><span class="p">[</span><span class="s">'lng'</span><span class="p">],</span> <span class="n">geo_data</span><span class="p">[</span><span class="s">'lat'</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>ç»“æœå¦‚ä¸‹ï¼š
<img src="image/4%201.png" alt="" /></p>
:ET