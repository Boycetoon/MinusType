---
layout: post
title: "CityEngine，形状语法与生成式城市设计"
categories:
  - 可以攻玉
tags:
  - 城市设计
  - 参数化
  - CityEngine
---
## 生成式城市设计的两种可能性
由于相当长一段时间对于数字辅助城市设计的关注，**生成式城市设计**也一直在我所关注的重点领域中。所谓生成式城市设计简单来说可以理解为建筑群体形态生成，对应着城市设计实务工作中从规划的用地结构进入具体的形态推敲环节，甚至可以说是城市设计呈现形式中与一般的城市规划最不同的阶段。
在传统的工作流程中massing环节往往耗时耗力，需要设计师白手起高楼，在一些经验和流程较为成熟的公司也存在预先做好的模块用来增加效率。但尽管如此，形态推敲的过程依然可以在实务工作中占据相当长的时间段。
如今的辅助设计技术如此发达当然在这样一个环节也是可以以逸待劳，生成式城市设计就是让机器代替人工来进行建筑的形态生成。并且随着近年各种技术逐渐成熟传到到下游，也被规划设计行业所看到，一些主攻这个方向的产品、工具也是逐渐出现。这其中的主流可以被分为两个方向，一个是基于规则的生成方法，另一个则是数据驱动的生成方法。
基于规则的方法其实历史久远，就是把一些生成的规则转换成逻辑化的算法，形成一个严密的生成模型；而数据驱动则是使用深度学习等方法，基于对大量案例样本的学习获得生成模型。其实这两个流派也正好类似于人工智能领域的符号主义和连接主义的区别。
就我之前对人工智能的粗糙理解一直朴素地认为深度学习是解决这些工业界问题的“简单方法”，毕竟只要有足够的数据集就能训练出简单易用的模型。所以之前也在关注一些使用深度学习方法来进行形体生成的研究。
但最近在工作中的一些反思和最近了解到的一些信息，使我对这两者在城市设计实务中应用的契合性产生了另外的思考。

## 一篇论文所描述的实践
首先是最近看到了一篇论文**Generative urban design using shape grammar and block morphological analysis（使用形状语法和街区形态分析的生成式城市设计）** ，它主要陈述了采用CityEngine和形状语法的规则式生成方式在一个实际项目中的应用过程。我首先在这里简单复述一下这个过程，当然对此感兴趣的读者尽量去阅读原文会有更详细的解释。

### 关于CityEngine
>CityEngine 是为从事城市设计研究的建筑师、规划师和相关人员提供的生成工具。 Parish and Müller (2001) 提出了一种城市的程序建模方法，并开发了最初的 CityEngine 版本，该版本是根据一组可理解的分层规则开发的，可以根据用户的需要进行扩展。Müller 等人。 (2006) 扩展了构建计算机生成架构 (CGA) 语言的方法。作为一种用于建筑物程序建模的新颖形状语法，CGA 可以生成具有高视觉质量和几何细节的建筑外壳。

曾经有一段时间因为一些宣传渠道我也对CityEngine有所了解，但是只限于知道它被广泛地应用在影视、游戏等大型城市场景的生成上，感觉就是一个快速生成城市模型的工具，而对其所涉及的生成算法不甚了解。后来再了解到ESRI官方软件的离谱定价就对这款软件更加敬而远之。

### 形成“语法”
因为规则式生成本质上就是设定各种参数，所以设计师需要知道设定哪些参数以及怎么设定，所以在进行设计之前需要对形态规则进行提取，就像城市设计常做的案例分析和形态提取一样，这里作者对南京市三个典型地段进行了形态提取（其中也涉及一些城市形态分析的方法，这里不做赘述），形成了类似下面这样的规则：

1. 当主干道长度在600米以下时，主干道为南北向，只有一条正交主干道与主干道垂直。当主干道长度超过600米时，设置两条正交线。
2. 每个街区的面积应为1公顷≤s≤3公顷，其纵横比不超过2。
3. 与每条主要街道相连的路口总数 J 应为 5 ≤ J ≤ 8。
4. 区块内所有路口的距离 D 为 80 米≤ D ≤ 200 米。
5. 70%~90% 的街区内不与周边主干道交叉的路口采用 T 字形。
6. 直接穿越周边主干道形成的街区内，30%~50%的交叉口采用T字形。
7. 街道深度为 3 或 4 米。

下一步就是将这样的规划转换成算法中的参数，CityEngine中控制参数的是一类特殊的规则文件，文件中存储了各种参数形式。可以对各个层级的形态要素的各种参数进行调整。
![](https://github.com/Boycetoon/MinusType/blob/master/image/形状语法与生成式城市设计/1-s2.0-S2095263520300662-gr9.jpg?raw=true)

对于城市设计而言，可以根据不同的功能、开发强度等规划指标来调整出不同类型的形态参数。
![](https://github.com/Boycetoon/MinusType/blob/master/image/形状语法与生成式城市设计/1-s2.0-S2095263520300662-gr10.jpg?raw=true)
![](https://github.com/Boycetoon/MinusType/blob/master/image/形状语法与生成式城市设计/1-s2.0-S2095263520300662-gr11.jpg?raw=true)

### 整体形态调整
通过以上的过程基本上就能够实现在有现成的规则文件的情况下可以对片区进行快速的形态生成，但CityEngine可以达成的效果不仅如此，它还可以根据宏观的一些规划设计调节来调整具体的形态参数。具体来说这里作者进行了整体城市片区的高度控制，这是在城市设计中必须要进行的一个步骤，但是一般的流程往往是在每个用地层面上调整高度，但是这里作者将一张位图格式的高度热力图作为参数输入就能直接生成经过调整后的模型。
![](https://github.com/Boycetoon/MinusType/blob/master/image/形状语法与生成式城市设计/1-s2.0-S2095263520300662-gr12.jpg?raw=true)
其实理解起来这样的过程也并不难实现，位图本身就含有位置和数值的信息，只需要根据数值的信息来对对应位置的建筑形态进行干扰就行了，这也就是GH等参数化软件中的常用形态干扰思路。但以这样成型的状态应用在城市设计的环节后就可以想象出它的易用性，我们输入的图像可以远远不像作者这样“成熟”，甚至我们随手绘制的一些想法的草图就能直接传入然后马上生成模型以进行判断，这样在最初期的结构确定后后续的工作可以完全通过规则编辑在模型上完成。

### 指标监看
对于城市设计来说，指标和形态同样重要，很多时候我们做完模型最终只是服务于效果和表现的部分，而指标的部分反而需要另行计算，甚至有可能形态的方案和指标控制相差甚远，其实这样的方法就基本上失去了城市设计本来的意义。而在CityEngine中可以很方便得进行各级指标的监看。
![](https://github.com/Boycetoon/MinusType/blob/master/image/形状语法与生成式城市设计/1-s2.0-S2095263520300662-gr13.jpg?raw=true)

## 对规则式生成算法的一些想法
我一直认为深度学习的特点在于“能够学习到人很难规则化的一些特征”，因为其本身存在特征提取的性能，所以似乎最终呈现出来的就是只要有足够丰富的样本就能学到现有城市形态的所有特点。但就目前来说这样的想法还是比较理想，一方面关于特征的问题，虽然上面说的那句话基本上是成立的，但是现在深度学习模型其实还是比较难以突破人的判断边界，因为这类模型基本上还是需要监督的；并且现代城市其实是非常典型的人造物，有着极其理性的工程特征，其中的规则其实应该是可以被设计师穷尽的，就算是一些并非明文的规则也是如此。另一方面是样本的问题，尽管现代城市已经是巨大的数量级，但形态生成模型需要一次接受一定范围的建筑形态作为训练基础，那么不同类型的样本就会有所不同，对于城市而言必然是有巨量的基础类型，但有一些特征较为特殊的类型是数量较少的。

重新审视规则式算法的话，我会认为它更适合城市设计领域。因为本身这一领域的很多设计决策过程是可以被规则化的，很多形态生成的实际指标也是。规则式生成的算法能给整个形态生成的过程更多的可解释性。在城市设计领域更是如此，城市设计本身不是具体的形态设计，而是形态导控，意思是在一些指标的限制条件下形成的城市形态风貌，具体的建筑设计是无法被固定成某一特定的形式的。所以我们常说城市设计的结果只是一种可能性而不是一种蓝图。在这样的思路下，规则式生成的算法其实十分符合城市设计的需要，其就是在固定一定的参数条件下采用随机和自适应生成的逻辑，我们甚至可以用同一个规则条件下生成不同的随机结果来判断现有的导控指标是否合适。

至于关于CityEngine，在这几天的了解过程中看了一些官方的教程和宣传视频，确实认识到近几年ESRI对这以工具的拓展较大，并且很明显在针对城市规划和设计领域进行布局。不过就ESRI软件的高昂价格，在国内想要正当地商用实在不容易，很多规划设计单位根本就没有这个方面的预算和意识。但实际看来，规则式的生成算法可以说是它的核心，因为比建模的话它不会比其他的专业建模软件更好。而宣传片中宣传的其他卖点也基本上在快速呈现效果，联动虚幻引擎来进行动画渲染等，我觉得这些在正常的工作流中都有其他的方法可以替代。那么这种规则生成的算法是否是独占的呢，就我初步看来应该不是，这种规则文件似乎也可以作为一种通用的格式被解析。之前看到了一个教程视频就是讲使用GH中的一个插件读取这种规则文件在Rhino中实现快速建模，这或许为这样的思路开启了新的可能性吧。

*最后需要做个声明，本文所写的东西一部分是参考论文中的，另一部分是我自己的一些想法，我对CityEngine和其中的算法了解还甚少，只是基于现在的一些了解探讨一些可能性，具体是不是可以这么做，如何做需要待后续继续了解。*

## 相关连接
1. [Generative urban design using shape grammar and block morphological analysis - ScienceDirect ~ 使用形状语法和街区形态分析的生成式城市设计 - ScienceDirect](https://www.sciencedirect.com/science/article/pii/S2095263520300662#bib22)
2. [3D Modelling with Grasshopper and CityEngine - YouTube](https://www.youtube.com/watch?v=AGItVOiFkcM&list=PLbdCqYwEj77QH-hDGX30NKD_gJ_fLHia4&index=2&t=53s)